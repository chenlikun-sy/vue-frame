"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){var s=42,a=10,h=350,f=50,r=Math.PI,l=62;function t(e,t){return Math.round(Math.random()*(t-e)+e)}function v(e){return document.createElement(e)}function d(e,t){e.classList.add(t)}function o(){return"imgs/jigsawImages/"+t(0,5)+".png"}function i(e,t,i,n){e.beginPath(),e.moveTo(i,n),e.lineTo(i+21,n),e.arc(i+21,n-a+2,a,0,2*r),e.lineTo(i+21,n),e.lineTo(i+s,n),e.lineTo(i+s,n+21),e.arc(i+s+a-2,n+21,a,0,2*r),e.lineTo(i+s,n+21),e.lineTo(i+s,n+s),e.lineTo(i,n+s),e.lineTo(i,n),e.fillStyle="#fff",e[t](),e.beginPath(),e.arc(i,n+21,a,1.5*r,.5*r),e.globalCompositeOperation="xor",e.fill()}function c(e,t){return e+t}function u(e){return e*e}var n=(_createClass(C,[{key:"init",value:function(){this.initDOM(),this.initImg(),this.draw(),this.bindEvents()}},{key:"initDOM",value:function(){var e,t,i,n=(e=h,t=f,(i=v("canvas")).width=e,i.height=t,i),s=n.cloneNode(!0),a=v("div"),r=v("div"),l=v("div"),o=v("div"),c=v("span"),d=v("span");s.className="block",a.className="sliderContainer",r.className="refreshIcon",l.className="sliderMask",o.className="slider",c.className="sliderIcon",d.innerHTML="向右滑动滑块填充拼图",d.className="sliderText";var u=this.el;u.appendChild(n),u.appendChild(r),u.appendChild(s),o.appendChild(c),l.appendChild(o),a.appendChild(l),a.appendChild(d),u.appendChild(a),Object.assign(this,{canvas:n,block:s,sliderContainer:a,refreshIcon:r,slider:o,sliderMask:l,sliderIcon:c,text:d,canvasCtx:n.getContext("2d"),blockCtx:s.getContext("2d")})}},{key:"initImg",value:function(){var e,t,i=this,n=(e=function(){i.canvasCtx.drawImage(n,0,0,h,f),i.blockCtx.drawImage(n,0,0,h,f);var e=i.y-20+2,t=i.blockCtx.getImageData(i.x,e,l,l);i.block.width=l,i.blockCtx.putImageData(t,0,e)},(t=v("img")).crossOrigin="Anonymous",t.onload=e,t.onerror=function(){t.src=o()},t.src=o(),t);this.img=n}},{key:"draw",value:function(){this.x=t(72,278),this.y=t(30,-22),i(this.canvasCtx,"fill",this.x,this.y),i(this.blockCtx,"clip",this.x,this.y)}},{key:"clean",value:function(){this.canvasCtx.clearRect(0,0,h,f),this.blockCtx.clearRect(0,0,h,f),this.block.width=h}},{key:"bindEvents",value:function(){var r=this;this.el.onselectstart=function(){return!1},this.refreshIcon.onclick=function(){r.reset()};var l=void 0,s=void 0,o=[],c=!1;this.slider.addEventListener("mousedown",function(e){l=e.x,s=e.y,c=!0}),document.addEventListener("mousemove",function(e){if(!c)return!1;var t=e.x-l,i=e.y-s;if(t<0||h<=38+t)return!1;r.slider.style.left=t+"px";var n=290/310*t;r.block.style.left=n+"px",d(r.sliderContainer,"sliderContainer_active"),r.sliderMask.style.width=t+"px",o.push(i)}),document.addEventListener("mouseup",function(e){if(!c)return!1;if(c=!1,e.x==l)return!1;var t,i;t=r.sliderContainer,i="sliderContainer_active",t.classList.remove(i),r.trail=o;var n=r.verify(),s=n.spliced,a=n.TuringTest;s?a?(d(r.sliderContainer,"sliderContainer_success"),r.success&&r.success()):(d(r.sliderContainer,"sliderContainer_fail"),r.text.innerHTML="再试一次",r.reset()):(d(r.sliderContainer,"sliderContainer_fail"),r.fail&&r.fail(),setTimeout(function(){r.reset()},1e3))})}},{key:"verify",value:function(){var e=this.trail,t=e.reduce(c)/e.length,i=e.map(function(e){return e-t}),n=Math.sqrt(i.map(u).reduce(c)/e.length),s=parseInt(this.block.style.left);return{spliced:Math.abs(s-this.x)<10,TuringTest:t!==n}}},{key:"reset",value:function(){this.sliderContainer.className="sliderContainer",this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.img.src=o(),this.draw()}}]),C);function C(e,t,i){_classCallCheck(this,C),this.el=e,this.success=t,this.fail=i}e.jigsaw={init:function(e,t,i){new n(e,t,i).init()}}}(window);